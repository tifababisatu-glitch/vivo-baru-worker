name: ğŸš€ Deploy Cloudflare Worker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout source
        uses: actions/checkout@v4

      - name: ğŸ§° Install Wrangler CLI
        run: npm install --global wrangler@4

      - name: ğŸš€ Deploy Worker to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
        run: |
          echo "ğŸ”§ Men-deploy Worker ke Cloudflare..."
          wrangler deploy --config wrangler.toml --env production \
            --var TG_TOKEN:$TG_TOKEN \
            --var TG_CHAT:$TG_CHAT

      - name: ğŸ“¢ Kirim notifikasi Telegram (jika deploy sukses)
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
        run: |
          echo "âœ… Mengirim notifikasi deploy sukses ke Telegram..."
          MESSAGE="âœ… *Deploy Cloudflare Worker Berhasil!*%0AğŸ“¦ Project: \`vivo-baru\`%0AğŸ•“ $(date '+%Y-%m-%d %H:%M:%S')"
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d "chat_id=$TG_CHAT" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

      - name: âŒ Kirim notifikasi gagal (jika deploy error)
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT: ${{ secrets.TG_CHAT }}
        run: |
          echo "âš ï¸ Deploy gagal, kirim notifikasi ke Telegram..."
          MESSAGE="âŒ *Deploy Cloudflare Worker Gagal!*%0AProject: \`vivo-baru\`%0APeriksa log di GitHub Actions."
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d "chat_id=$TG_CHAT" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
