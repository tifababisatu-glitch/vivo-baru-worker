name: üöÄ Deploy Cloudflare Worker

on:
  push:
    branches: [ "main" ]          # Jalankan otomatis setiap push ke branch main
  workflow_dispatch:               # Bisa juga dijalankan manual lewat "Run workflow"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout source
        uses: actions/checkout@v4

      - name: üß∞ Install Wrangler CLI
        run: npm install --global wrangler@4

      - name: üöÄ Deploy Worker to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "üîß Men-deploy Worker ke Cloudflare..."
          wrangler deploy --config wrangler.toml --env production \
            --var TG_BOT_TOKEN:$TG_BOT_TOKEN \
            --var TG_CHAT_ID:$TG_CHAT_ID

      - name: üì¢ Kirim notifikasi Telegram (jika deploy sukses)
        if: ${{ success() }}
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "‚úÖ Mengirim notifikasi deploy sukses ke Telegram..."
          MESSAGE="‚úÖ *Deploy Cloudflare Worker Berhasil!*%0Aüì¶ Project: \`vivo-baru\`%0Aüïì $(date '+%Y-%m-%d %H:%M:%S')"
          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TG_CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"

      - name: ‚ùå Kirim notifikasi gagal (jika deploy error)
        if: ${{ failure() }}
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          echo "‚ö†Ô∏è Deploy gagal, kirim notifikasi ke Telegram..."
          MESSAGE="‚ùå *Deploy Cloudflare Worker Gagal!*%0AProject: \`vivo-baru\`%0APeriksa log di GitHub Actions."
          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TG_CHAT_ID" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
